<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>JSON to Array shape converter</title>

    <script type="module">
      document.documentElement.classList.remove('no-js');
      document.documentElement.classList.add('js');
    </script>
    <link rel="stylesheet" type="text/css" href="./output.css" />

    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js" integrity="sha256-qXBd/EfAdjOA2FGrGAG+b3YBn2tn5A6bhz+LSgYD96k=" crossorigin="anonymous"></script>

    <meta name="description" content="Small web tool that lets you convert JSON into array shape format.">
    <meta property="og:title" content="JSON to Array shape converter - Can Vural">
    <meta property="og:description" content="Small web tool that lets you convert JSON into array shape format.">
    <meta property="og:locale" content="en_GB">
    <meta property="og:type" content="website">
</head>

<body class="bg-zinc-50 h-screen flex items-center justify-center">
    <main class="shadow-2xl rounded-md bg-stone-50 md:-mt-24 p-8 container mx-auto flex flex-col items-center ">
        <div class="relative">
            <label for="input-json" class="block text-sky-600 text-lg font-semibold">JSON data</label>
            <textarea name="input-json" id="input-json" class="mt-2 p-2 focus:outline-none focus:ring focus:ring-sky-300 overflow-y-scroll h-[200px] min-h-[200px]" cols="30" rows="10" placeholder="{}"></textarea>
            <div id="delete-button" class="absolute bottom-2 right-2 cursor-pointer text-slate-400 hover:text-slate-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            </div>
        </div>
        <span class="text-red-600" id="error"></span>
        <div class="flex flex-row items-center">
            <div class="mt-6">
                <label for="generalize" class="ml-2">Generalize types</label>
                <input type="checkbox" class="ml-2" name="generalize" id="generalize" />
            </div>
        </div>

        <hr class="border-1 my-6 w-full border-dashed border-slate-300" />

        <div class="mt-2">
            <label for="result-shape" class="block text-sky-600 text-lg font-semibold">Array shape</label>
            <textarea readonly name="result-shape" id="result-shape" class="mt-2 p-2 focus:outline-none focus:ring focus:ring-sky-300 overflow-y-scroll h-[200px] min-h-[200px]" cols="30" rows="10" placeholder="array{}"> </textarea>
        </div>
    </main>
    <script>
      const convertJsonToArrayShape = function (e) {
        let rawJson = document.getElementById('input-json').value
        let json = parseJson(rawJson)

        document.getElementById('result-shape').value = toShape(json)
      }

      document.getElementById('input-json').addEventListener('input', _.debounce(convertJsonToArrayShape, 350))
      document.getElementById('generalize').addEventListener('change', _.debounce(convertJsonToArrayShape, 100))
      document.getElementById('delete-button').addEventListener('click', function () { document.getElementById('input-json').value = ''; document.getElementById('result-shape').value = '' })

      document.getElementById("result-shape").addEventListener("click", () => {
        document.getElementById('result-shape').select()
        document.execCommand("copy");
      });

      function parseJson(rawJson) {
        try {
          const parsed = JSON.parse(rawJson)
          document.getElementById('error').innerHTML = ''
          return parsed
        } catch (e) {
          document.getElementById('error').innerHTML = 'You did not enter valid JSON.'
          return {}
        }
      }

      function getType(obj) {
        if (obj === null) return "null";
        if (obj === undefined) return "null";
        if (_.isArray(obj)) return "array";
        if (_.isObject(obj)) return "object";
        if (_.isString(obj)) return "string";
        if (_.isInteger(obj)) return "int";
        if (_.isBoolean(obj)) return "bool";
        if (_.isNumber(obj)) return "float";
        return "?";
      }

      const toShape = (json) => {
        let schema = "";
        function traverse(obj) {
          let type = getType(obj);

          if (type === "array") {
            if (obj.length < 1) {
              return "array{}";
            }

            if (document.getElementById('generalize').checked) {
              let uniqTypes = _.uniq(_.map(obj, traverse));

              if (uniqTypes.length === 1) {
                return `array<int, ${uniqTypes[0]}>`;
              }

              return `array<${_.join(uniqTypes, "|")}>`;
            } else {
              return `array{${_.map(obj, (v, k) => {
                if (_.isArray(v) || _.isObject(v)) {
                  return `${_.isInteger(k) ? "" : k + ":"} ${traverse(v)}`;
                }

                if (_.isString(v)) {
                  v = `"${v}"`;
                }

                return `${_.isInteger(k) ? "" : k + ":"} ${v}`;
              }).join(", ")}}`;
            }
          }

          if (type === "object") {
            if (document.getElementById('generalize').checked) {
              return (
                "array<string, " +
                _.uniq(Object.keys(obj)
                  .map((k, i) => {
                    return `${traverse(obj[k])}`;
                  }))
                .join("|") +
                ">"
              );
            }

            return (
              "array{" +
              Object.keys(obj)
                .map((k, i) => {
                  return `${k}: ${traverse(obj[k])}`;
                })
                .join(",") +
              "}"
            );
          }

          if (document.getElementById('generalize').checked) {
            return type;
          }

          if (_.isString(obj)) {
            return `"${obj}"`;
          }

          return obj;
        }

        return traverse(json);
      };
    </script>
</body>
</html>
